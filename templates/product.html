{% extends "base.html" %}
{% block content %}
{% include 'owner-navbar.html' %}
{% block owner_navbar %}{% endblock owner_navbar %}

<div class="page-container">

  <h2 class="page-title mb-4">ðŸ›’ Product Management</h2>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show"
    role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <!-- Product Form -->
  <div class="section-card mb-4">
    <h5 class="fw-semibold mb-3">Add / Edit Product</h5>
    <form method="POST" action="/update_product" enctype="application/x-www-form-urlencoded">
      <input type="hidden" name="product_id" id="edit_product_id" value="">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Product Name</label>
          <input type="text" name="product_name" id="product_name" class="form-control" placeholder="e.g. Rice"
            required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Rate (â‚¹)</label>
          <input type="number" name="rate" id="product_rate" class="form-control" placeholder="e.g. 60" step="0.01"
            required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Unit</label>
          <select name="unit" id="product_unit" class="form-select" required>
            <option value="">Select Unit</option>
            <option value="kg">Per Kg</option>
            <option value="liter">Per Liter</option>
            <option value="piece">Per Piece</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Profit (â‚¹)</label>
          <input type="number" name="profit" id="product_profit" class="form-control" placeholder="e.g. 5" step="0.01"
            required>
        </div>
        <div class="col-md-2 d-grid">
          <button type="submit" class="btn btn-primary" id="submit_btn">
            <i class="bi bi-check-circle"></i> <span id="submit_text">Add Product</span>
          </button>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-12">
          <button type="button" class="btn btn-secondary btn-sm" onclick="clearForm()">
            <i class="bi bi-x-circle"></i> Clear Form
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Products Table -->
  <div class="section-card">
    <h5 class="fw-semibold mb-3">Available Products</h5>
    <div class="table-responsive">
      <table class="table table-hover align-middle text-center">
        <thead>
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Rate</th>
            <th>Unit</th>
            <th>Profit</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if products %}
          {% for product in products %}
          <tr>
            <td>{{ loop.index }}</td>
            <td class="fw-semibold">{{ product.product_name }}</td>
            <td>â‚¹{{ product.rate }}</td>
            <td><span class="badge badge-ok">{{ product.unit }}</span></td>
            <td><span class="text-success fw-bold">â‚¹{{ product.profit }}</span></td>
            <td>
              <button type="button" class="btn btn-sm btn-warning action-btn me-1"
                data-product-id="{{ product.product_id }}" data-product-name="{{ product.product_name }}"
                data-product-rate="{{ product.rate }}" data-product-unit="{{ product.unit }}"
                data-product-profit="{{ product.profit }}" onclick="editProductFromButton(this)">
                <i class="bi bi-pencil"></i> Edit
              </button>
              <form method="POST" action="/delete_product" style="display: inline;"
                onsubmit="return confirm('Are you sure you want to delete this product?')">
                <input type="hidden" name="product_id" value="{{ product.product_id }}">
                <button type="submit" class="btn btn-sm btn-danger action-btn">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="6" class="text-muted py-4">
              No products added yet. Use the form above to add products.
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
  function editProductFromButton(button) {
    // Get data from button attributes
    const id = button.getAttribute('data-product-id');
    const name = button.getAttribute('data-product-name');
    const rate = button.getAttribute('data-product-rate');
    const unit = button.getAttribute('data-product-unit');
    const profit = button.getAttribute('data-product-profit') || '0';

    // Fill form with product data
    document.getElementById('edit_product_id').value = id;
    document.getElementById('product_name').value = name;
    document.getElementById('product_rate').value = rate;
    document.getElementById('product_unit').value = unit;
    document.getElementById('product_profit').value = profit;

    // Change button text
    document.getElementById('submit_text').textContent = 'Update Product';

    // Scroll to form
    document.querySelector('.section-card').scrollIntoView({ behavior: 'smooth' });
  }

  function clearForm() {
    document.getElementById('edit_product_id').value = '';
    document.getElementById('product_name').value = '';
    document.getElementById('product_rate').value = '';
    document.getElementById('product_unit').value = '';
    document.getElementById('product_profit').value = '';
    document.getElementById('submit_text').textContent = 'Add Product';
  }
</script>

<style>
  .action-btn {
    border-radius: 8px;
  }

  .badge {
    padding: 6px 10px;
    border-radius: 20px;
    font-weight: 600;
  }
</style>

{% endblock content %}