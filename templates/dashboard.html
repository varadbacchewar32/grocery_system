{% extends "base.html" %}
{% block content %}
{% include 'owner-navbar.html' %}

<div class="page-container fade-in">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-5">
    <div>
      <h2 class="mb-1 fw-bold text-dark">Dashboard</h2>
      <p class="text-secondary mb-0">Welcome back! Here's what's happening today.</p>
    </div>
    <div class="d-flex gap-2">
      {{ current_date }}
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div
    class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show shadow-sm border-0"
    role="alert">
    <div class="d-flex align-items-center gap-2">
      <i
        class="bi {{ 'bi-check-circle-fill text-success' if category == 'success' else 'bi-exclamation-circle-fill text-danger' }}"></i>
      {{ message }}
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <!-- Stats Grid -->
  <div class="row g-4 mb-5">

    <!-- Revenue Card -->
    <div class="col-md-3">
      <div class="summary-card h-100 position-relative overflow-hidden border-0"
        style="background: linear-gradient(135deg, #4F46E5 0%, #4338ca 100%); color: white;">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <p class="mb-0 opacity-75 small text-uppercase fw-bold tracking-wider">Today's Revenue</p>
            <h3 class="fw-bold mb-0 mt-1">â‚¹{{ daily_sales }}</h3>
          </div>
          <div class="bg-white bg-opacity-25 rounded-3 p-2">
            <i class="bi bi-currency-rupee fs-4"></i>
          </div>
        </div>
        <div class="small opacity-75">
          <i class="bi bi-arrow-up-right"></i> {{ daily_bills }} Bills processed
        </div>
      </div>
    </div>

    <!-- Cash/UPI Card -->
    <div class="col-md-3">
      <div class="summary-card h-100 border-0 bg-white">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <p class="text-secondary mb-0 small text-uppercase fw-bold tracking-wider">Payment Split</p>
            <div class="mt-2">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-2">Cash</span>
                <span class="fw-bold">â‚¹{{ cash_sales }}</span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-2">UPI</span>
                <span class="fw-bold">â‚¹{{ upi_sales }}</span>
              </div>
            </div>
          </div>
          <div class="bg-warning bg-opacity-10 text-warning rounded-3 p-2">
            <i class="bi bi-wallet2 fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Profit Analysis -->
    <div class="col-md-3">
      <div class="summary-card h-100 border-0 bg-white">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <p class="text-secondary mb-0 small text-uppercase fw-bold tracking-wider">Profitability</p>
            <div class="mt-2">
              <div class="mb-1">
                <small class="text-muted">Net Profit</small>
                <div class="fw-bold text-success">â‚¹{{ daily_profit }}</div>
              </div>
              <div>
                <small class="text-muted">Margin</small>
                <div class="fw-bold">{{ profit_margin }}%</div>
              </div>
            </div>
          </div>
          <div class="bg-success bg-opacity-10 text-success rounded-3 p-2">
            <i class="bi bi-graph-up-arrow fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Low Stock -->
    <div class="col-md-3">
      <div class="summary-card h-100 border-0 bg-white">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <p class="text-secondary mb-0 small text-uppercase fw-bold tracking-wider">Inventory Alert</p>
            <h3 class="fw-bold mb-0 mt-1 {{ 'text-danger' if low_stock > 0 else 'text-success' }}">{{ low_stock }}</h3>
            <p class="small text-muted mt-1">Items Low on Stock</p>
          </div>
          <div class="bg-danger bg-opacity-10 text-danger rounded-3 p-2">
            <i class="bi bi-exclamation-triangle fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="row g-4 mb-5">

    <!-- Left Column: Chart & Recent Sales -->
    <div class="col-lg-8">

      <!-- Sales Chart -->
      <div class="section-card mb-4" style="min-height: 400px;">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="fw-bold m-0 text-dark">ðŸ“ˆ Weekly Sales Trend</h5>
        </div>
        <div class="position-relative" style="height: 300px; width: 100%;">
          <canvas id="salesChart"></canvas>
        </div>
      </div>

      <!-- Recent Transactions Table -->
      <div class="section-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="fw-bold m-0 text-dark">Recent Transactions</h5>
          <a href="/bill" class="btn btn-sm btn-light text-primary fw-medium small">View All</a>
        </div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="bg-light">
              <tr>
                <th class="ps-3 border-top-0 rounded-start">Bill No</th>
                <th class="border-top-0">Amount</th>
                <th class="border-top-0">Mode</th>
                <th class="border-top-0 text-end pe-3 rounded-end">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for sale in recent_sales %}
              <tr class="hover-bg-gray transition-all">
                <td class="ps-3 text-secondary fw-medium">#{{ sale.sale_id }}</td>
                <td class="fw-bold text-dark">â‚¹{{ sale.total_amount }}</td>
                <td>
                  {% if sale.payment_mode == 'UPI' %}
                  <span
                    class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10 px-2 py-1">UPI</span>
                  {% else %}
                  <span
                    class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-10 px-2 py-1">Cash</span>
                  {% endif %}
                </td>
                <td class="text-end pe-3">
                  <a href="/bill?sale_id={{ sale.sale_id }}"
                    class="btn btn-sm btn-white border shadow-sm text-secondary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center text-muted py-4">No recent transactions</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- Right Column: Add Product & Inventory -->
    <div class="col-lg-4">

      <!-- Add Product Form -->
      <div class="section-card mb-4 bg-primary text-white position-relative overflow-hidden border-0"
        style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);">

        <h5 class="fw-bold mb-4 position-relative">âœ¨ Add Quick Item</h5>
        <form method="POST" action="/add_product">
          <div class="mb-3">
            <label class="form-label small text-uppercase text-white-50 fw-bold tracking-wider">Item Name</label>
            <input type="text" name="product_name"
              class="form-control form-control-dark bg-white bg-opacity-10 border-0 text-white placeholder-white-50"
              placeholder="e.g. Basmati Rice" required style="backdrop-filter: blur(5px);">
          </div>
          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label small text-uppercase text-white-50 fw-bold tracking-wider">Rate (â‚¹)</label>
              <input type="number" name="rate" class="form-control bg-white bg-opacity-10 border-0 text-white"
                placeholder="0.00" step="0.01" required>
            </div>
            <div class="col-6">
              <label class="form-label small text-uppercase text-white-50 fw-bold tracking-wider">Profit (â‚¹)</label>
              <input type="number" name="profit" class="form-control bg-white bg-opacity-10 border-0 text-white"
                placeholder="0.00" step="0.01" required>
            </div>
          </div>
          <div class="mb-4">
            <label class="form-label small text-uppercase text-white-50 fw-bold tracking-wider">Unit & Unit Type</label>
            <!-- Assuming simple input for now or select, keeping layout clean -->
            <div class="input-group">
              <select name="unit" class="form-select bg-white bg-opacity-10 border-0 text-white">
                <option value="kg" class="text-dark">Kg</option>
                <option value="liter" class="text-dark">Liter</option>
                <option value="piece" class="text-dark">Piece</option>
              </select>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100 fw-bold shadow-lg"
            style="background: #4F46E5; border: none;">
            Add to Inventory <i class="bi bi-arrow-right ms-2"></i>
          </button>
          <!-- Hidden profit field if we moved it out, but I added it above -->
        </form>
      </div>

      <!-- Inventory Status List -->
      <div class="section-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="fw-bold m-0 text-dark">ðŸ“¦ Stock Status</h5>
          <a href="/inventory" class="btn btn-sm btn-light text-primary fw-medium small">Manage</a>
        </div>
        <div class="d-flex flex-column gap-3" style="max-height: 400px; overflow-y: auto;">
          {% for item in inventory_items %}
          <div
            class="d-flex align-items-center justify-content-between p-2 rounded-3 hover-bg-gray transition-all border border-transparent">
            <div class="d-flex align-items-center gap-3">
              <div class="bg-light rounded-circle d-flex align-items-center justify-content-center text-secondary"
                style="width: 40px; height: 40px;">
                <i class="bi bi-box"></i>
              </div>
              <div>
                <h6 class="mb-0 fw-semibold text-dark">{{ item.product.product_name }}</h6>
                <small class="text-muted">{{ item.quantity }} {{ item.product.unit }} in stock</small>
              </div>
            </div>
            <div>
              {% if item.quantity == 0 %}
              <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-10">Out</span>
              {% elif item.quantity < 5 %} <span
                class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-10">Low</span>
                {% else %}
                <span
                  class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-10">OK</span>
                {% endif %}
            </div>
          </div>
          {% else %}
          <p class="text-muted text-center py-3">No inventory data</p>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Chart Script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('salesChart').getContext('2d');

    // Gradient for the chart
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(79, 70, 229, 0.2)'); // Brand Color
    gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

    const chartData = {{ chart_data | tojson
  }};

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: chartData.labels,
      datasets: [{
        label: 'Daily Sales (â‚¹)',
        data: chartData.data,
        backgroundColor: gradient,
        borderColor: '#4F46E5',
        borderWidth: 2,
        pointBackgroundColor: '#ffffff',
        pointBorderColor: '#4F46E5',
        pointBorderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6,
        fill: true,
        tension: 0.4 // Smooth curve
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: '#1e293b',
          padding: 12,
          displayColors: false,
          callbacks: {
            label: function (context) {
              return 'â‚¹' + context.parsed.y;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: '#f1f5f9',
            borderDash: [5, 5]
          },
          ticks: {
            font: { family: 'Inter', size: 11 },
            color: '#94a3b8'
          },
          border: { display: false }
        },
        x: {
          grid: { display: false },
          ticks: {
            font: { family: 'Inter', size: 11 },
            color: '#94a3b8'
          },
          border: { display: false }
        }
      }
    }
  });
});
</script>
{% endblock content %}