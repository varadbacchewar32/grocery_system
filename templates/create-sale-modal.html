<!-- Create Sale Modal -->
<div class="modal fade" id="saleModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">ðŸ§¾ Create New Sale</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Add Item -->
        <div class="row g-2 mb-3">
          <div class="col-md-5">
            <label class="form-label">Product</label>
            <select id="saleProduct" class="form-select">
              <option value="">Select Product</option>
              {% for p in products %}
              <option value="{{ p.product_id }}|{{ p.rate }}|{{ p.product_name }}">{{ p.product_name }} (â‚¹{{ p.rate }}/{{ p.unit }})</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Quantity</label>
            <input type="number" id="saleQty" class="form-control" placeholder="Qty">
          </div>

          <div class="col-md-2 d-grid align-items-end">
            <button class="btn btn-primary" onclick="addSaleItem()">Add</button>
          </div>
        </div>

        <!-- Sale Items -->
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Rate</th>
              <th>Qty</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="saleItemsTable">
            <tr>
              <td colspan="5" class="text-center text-muted">
                No items added
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Payment Mode -->
         <div class="row mt-3">
             <div class="col-md-6">
                 <label class="form-label">Payment Mode</label>
                 <select id="paymentMode" class="form-select">
                     <option value="Cash">Cash</option>
                     <option value="UPI">UPI</option>
                 </select>
             </div>
             <div class="col-md-6 text-end">
                <h5>Total: â‚¹<span id="saleGrandTotal">0</span></h5>
             </div>
         </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" onclick="submitSale()">Create Sale</button>
      </div>

    </div>
  </div>
</div>

<script>
let saleItems = [];
let saleTotal = 0;

function addSaleItem(){
  const productValue = document.getElementById('saleProduct').value;
  const qty = Number(document.getElementById('saleQty').value);

  if(!productValue || qty <= 0){
    alert("Select product and valid quantity");
    return;
  }

  const [productId, rate, name] = productValue.split("|");
  const itemTotal = Number(rate) * qty;

  // Check if exists
  const existing = saleItems.find(i => i.product_id === productId);
  if(existing){
      existing.qty += qty;
      existing.itemTotal += itemTotal;
  } else {
      saleItems.push({product_id: productId, name, rate, qty, itemTotal});
  }
  
  renderSaleItems();
  
  // Reset fields
  document.getElementById('saleQty').value = '';
  document.getElementById('saleProduct').value = '';
}

function renderSaleItems(){
  const tbody = document.getElementById('saleItemsTable');
  tbody.innerHTML = "";
  saleTotal = 0;

  if(saleItems.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No items added</td></tr>`;
      document.getElementById('saleGrandTotal').innerText = "0";
      return;
  }

  saleItems.forEach((item, i) => {
    saleTotal += item.itemTotal;
    tbody.innerHTML += `
      <tr>
        <td>${item.name}</td>
        <td>â‚¹${item.rate}</td>
        <td>${item.qty}</td>
        <td>â‚¹${item.itemTotal}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="removeSaleItem(${i})">âœ–</button>
        </td>
      </tr>
    `;
  });

  document.getElementById('saleGrandTotal').innerText = saleTotal;
}

function removeSaleItem(index){
  saleItems.splice(index,1);
  renderSaleItems();
}

function submitSale(){
    if(saleItems.length === 0){
        alert("Please add items to sale");
        return;
    }
    
    const paymentMode = document.getElementById('paymentMode').value;
    
    const payload = {
        payment_mode: paymentMode,
        items: saleItems.map(i => ({
            product_id: i.product_id,
            quantity: i.qty
        }))
    };
    
    fetch('/create_sale', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if(data.success){
            // alert("Sale created successfully!");
            window.location.href = `/bill?sale_id=${data.sale_id}`;
        } else {
            alert("Error: " + data.message);
        }
    })
    .catch(err => {
        console.error(err);
        alert("Failed to create sale");
    });
}
</script>

